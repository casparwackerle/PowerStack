---
# -- Replaces the name of the chart in the Chart.yaml file
nameOverride: ""
# -- Replaces the generated name
fullnameOverride: ""

image:
  # -- Repository to pull the image from
  repository: "ghcr.io/casparwackerle/tycho-energy"
  # -- Image tag, if empty it will get it from the chart's appVersion
  tag: "latest"
  # -- Pull policy
  pullPolicy: Always

# -- Secret name for pulling images from private repository
imagePullSecrets: []

# -- Additional DaemonSet annotations
annotations: {}

# -- Additional pod annotations
podAnnotations: {}

# -- Additional pod labels
podLabels: {}

# -- Privileges and access control settings for a Pod (all containers in a pod)
podSecurityContext: {}
  # fsGroup: 2000

# -- Privileges and access control settings for a container
securityContext:
  privileged: true

# -- Node selection constraint
nodeSelector:
  kubernetes.io/os: linux

# -- Toleration for taints
tolerations:
  - effect: NoSchedule
    key: node-role.kubernetes.io/control-plane

# -- Affinity rules
affinity: {}

# -- CPU/MEM resources
resources: {}

# -- Extra environment variables
extraEnvVars:
  KEPLER_LOG_LEVEL: "2"           #reduce log level to 5 for finished builds
  METRIC_PATH: "/metrics"
  BIND_ADDRESS: "0.0.0.0:9102"
  ENABLE_GPU: "false"
  ENABLE_QAT: "false"
  ENABLE_EBPF_CGROUPID: "true"
  EXPOSE_HW_COUNTER_METRICS: "true"
  EXPOSE_IRQ_COUNTER_METRICS: "true"
  EXPOSE_CGROUP_METRICS: "true"
  ENABLE_PROCESS_METRICS: "true"
  CPU_ARCH_OVERRIDE: ""
  CGROUP_METRICS: '*'
  REDFISH_PROBE_INTERVAL_IN_SECONDS: "60"
  REDFISH_SKIP_SSL_VERIFY: "true"

  # Enable flags
  TYCHO_COLLECTOR_ENABLE_BPF: "true"
  TYCHO_COLLECTOR_ENABLE_RAPL: "true"
  TYCHO_COLLECTOR_ENABLE_GPU: "true"
  TYCHO_COLLECTOR_ENABLE_REDFISH: "true"

  # Measurement Periods (milliseconds)
  TYCHO_BUFFER_WINDOW_SEC: 90

  TYCHO_BPF_POLL_MS: "50"
  TYCHO_RAPL_POLL_MS: "50"
  TYCHO_GPU_POLL_MS: "200"
  TYCHO_GPU_PHASE_AWARE_SAMPLING: "true" # only enable if TYCHO_CALIBRATION_GPU_POLL_ENABLE=true, or you accurately determined your card's update inteval in TYCHO_GPU_POLL_MS
  TYCHO_REDFISH_POLL_MS: "1000" # Polling cadence (milliseconds). To catch every BMC publish, set this LOWER than the BMCâ€™s actual cadence. If unknown, 1000 ms is a safe, low-overhead default for many servers.
  TYCHO_PROCESS_POLL_SEC: "1"
  TYCHO_KUBELET_POLL_SEC: "3"
  TYCHO_METAENGINE_POLL_SEC: "1"

  # Optional timing extras: Metric delay (i.e. the delay between a workload change and it's representation in the metric). Insert if known, otherwise keep at 0.
  TYCHO_TIMEBASE_QUANTUM_MS: "1"
  TYCHO_BPF_DELAY_MS: "0"
  TYCHO_RAPL_DELAY_MS: "0"
  TYCHO_GPU_DELAY_MS: "200"
  TYCHO_REDFISH_DELAY_MS: "1000" 
  TYCHO_REDFISH_HEARTBEAT_MAX_GAP_MS: "3000" # Heartbeat timeout (milliseconds). Set to 150% of the known BMC publishing frequency, if known. Otherwise set to 15000 as a safe, conservative default.

  # CalibrationRaplPollMinMs
  TYCHO_CALIBRATION_REDFISH_CONTINUOUS_HEARTBEAT_ENABLE: "true" # keep Redfish connection alive during calibration
  TYCHO_CALIBRATION_REDFISH_POLL_ENABLE: "true"                 # enable Redfish poll-rate calibration
  TYCHO_CALIBRATION_REDFISH_POLL_BUDGET_SEC: "300"               # max duration for Redfish poll-rate probe
  TYCHO_CALIBRATION_GPU_POLL_ENABLE: "true"                     # enable GPU poll-rate calibration
  TYCHO_CALIBRATION_GPU_POLL_BUDGET_SEC: "300"                   # max duration for GPU poll-rate probe

  TYCHO_COLLECTOR_GPU_PREFER_DCGM: "false"
  TYCHO_COLLECTOR_GPU_ENABLE_PERPROCESS: "true"
  TYCHO_COLLECTOR_GPU_ENABL_MIGDISCOVERY: "false"

  # Optional analysis knobs you already wired
  TYCHO_ANALYSIS_TRIGGER: "timer" # "redfish" | "timer"
  TYCHO_ANALYSIS_EVERY_SEC: "3"
  TYCHO_ANALYSIS_DETECT_LONGEST_DELAY: "false"
  TYCHO_ANALYSIS_GPU_QUANTUM_MS: 50
  TYCHO_ANALYSIS_GPU_HISTORY_WINDOW_SEC: 60
  TYCHO_ANALYSIS_GPU_SOLVE_WINDOW_SEC: 5    # same as TYCHO_ANALYSIS_EVERY_SEC
  TYCHO_ANALYSIS_ENABLE_GPU_ENERGY_CONSTRAINTS: true
  TYCHO_ANALYSIS_FUSION_QUANTUM_MS: 50
  TYCHO_ANALYSIS_FUSION_HORIZON_SEC: 90
  TYCHO_ANALYSIS_FUSION_REDFISH_KERNEL: "avg1s_trailing"
  TYCHO_ANALYSIS_FUSION_REDFISH_KERNEL_MS: 1000
  TYCHO_ANALYSIS_FUSION_DIAGNOSTICS: false
  TYCHO_ANALYSIS_IDLE_DIAGNOSTICS: false
  TYCHO_ANALYSIS_ATTRIBUTION_DIAGNOSTICS: false

canMount:
  usrSrc: true  # /usr/src may not available, ie GKE

service:
  annotations: {}
  type: ClusterIP
  port: 9102

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

serviceMonitor:
  enabled: true
  namespace: tycho 
  interval: 10s
  scrapeTimeout: 5s
  labels: {}
  attachMetadata:
    node: false
  relabelings:
    - action: replace
      regex: (.*)
      replacement: $1
      sourceLabels:
        - __meta_kubernetes_pod_node_name
      targetLabel: instance
## SOURCE: https://github.com/digitalocean/Kubernetes-Starter-Kit-Developers/blob/main/04-setup-observability/assets/manifests/prom-stack-values-v35.5.1.yaml
##
## Starter Kit configuration for Prometheus stack
##
defaultRules:
  create: true
  rules:
    etcd: false
    kubeScheduler: false

kubeScheduler:
  enabled: false

kubeEtcd:
  enabled: false

alertmanager:
  enabled: true
  alertmanagerSpec:
    storage:
      volumeClaimTemplate:
        metadata:
          name: {{ pvc_name }}-alertmanager
        spec:
          accessModes:
            - {{ storage_accessmode }}
          resources:
            requests:
              storage: {{ pvc_size_alertmanager }}
          selector:
            matchLabels:
              app: alertmanager
          storageClassName: {{ storageclass_name }}

grafana:
  enabled: true
  adminPassword: {{ ansible_vault.grafanaAdminPassword }}
  grafana.ini:
    dashboards:
      min_refresh_interval: 1s
    server:
      domain: newnan.zhaw.ch
      root_url: "http://newnan.zhaw.ch:30003/"
    rendering:
      server_url: http://localhost:8081/render
      callback_url: http://localhost:3000/

  # Disable the separate renderer deployment if your chart supports it.
  # If not supported, you can leave it running; Grafana will use localhost anyway.
  imageRenderer:
    enabled: false

  extraContainers: |
    - name: grafana-image-renderer-sidecar
      image: grafana/grafana-image-renderer:latest
      ports:
        - name: renderer
          containerPort: 8081
      env:
        - name: HTTP_HOST
          value: "0.0.0.0"
        - name: HTTP_PORT
          value: "8081"


  persistence:
    enabled: true
    existingClaim: {{ pvc_name }}-grafana

prometheus:
  enabled: true
  prometheusSpec:
    additionalScrapeConfigs:
      - job_name: 'kepler-metrics'
        static_configs:
          - targets:
{% set scrape_port = prometheus_kepler_port | default(9102) %}
{% set servers = groups['server'] | default([]) %}
{% set agents  = groups['agent']  | default([]) %}
{% set all_hosts = (servers + agents) %}
{% if all_hosts|length > 0 %}
{%   for h in all_hosts %}
            - "{{ hostvars[h].external_ip | default(h) }}:{{ scrape_port }}"
{%   endfor %}
{% else %}
            []
{% endif %}
    scrapeInterval: "{{ prometheus_scrape_interval }}"
    securityContext:
      enabled: true
      runAsUser: 65534
      fsGroup: 65534
    storageSpec:
      volumeClaimTemplate:
        metadata:
          name: {{ pvc_name }}-prometheus
        spec:
          accessModes:
            - {{ storage_accessmode }}
          resources:
            requests:
              storage: {{ pvc_size_prometheus }}
          selector:
            matchLabels:
              app: prometheus
          storageClassName: {{ storageclass_name }}

prometheusOperator:
  enabled: true
